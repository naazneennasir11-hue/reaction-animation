<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reaction with Bond Formation</title>
<style>
  body { margin: 0; overflow: hidden; font-family: sans-serif;}
  canvas { display: block; }
  #ui { position: absolute; top: 10px; left: 10px; z-index: 10; }
  button { padding: 8px 12px; margin-right: 5px; }
</style>
</head>
<body>
<div id="ui">
  <button id="prev">Previous</button>
  <button id="next">Next</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf0f0f0);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,0,25);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

const light1 = new THREE.PointLight(0xffffff,1);
light1.position.set(20,20,20);
scene.add(light1);
scene.add(new THREE.AmbientLight(0x888888));

const atomColors = {C:0x555555,H:0xffffff,O:0xff0000,N:0x0000ff};

const moleculeSteps = [
  {name:"Furfural Alcohol", atoms:[{el:"C",pos:[-2,0,0]},{el:"C",pos:[-1,1,0]},{el:"O",pos:[0,0,0]},{el:"H",pos:[-2,-1,0]},{el:"H",pos:[-1,2,0]}], bonds:[[0,1],[1,2],[0,3],[1,4]]},
  {name:"Furan Sugar-like", atoms:[{el:"C",pos:[-1,0,0]},{el:"C",pos:[0,1,0]},{el:"O",pos:[1,0,0]},{el:"H",pos:[-2,0,0]},{el:"H",pos:[0,2,0]}], bonds:[[0,1],[1,2],[0,3],[1,4]]},
  {name:"Protected Sugar", atoms:[{el:"C",pos:[-1,0,0]},{el:"C",pos:[0,1,0]},{el:"O",pos:[1,0,0]},{el:"H",pos:[-2,0,0]},{el:"N",pos:[0,2,0]}], bonds:[[0,1],[1,2],[0,3],[1,4]]},
  {name:"Aza-base", atoms:[{el:"C",pos:[0,0,0]},{el:"N",pos:[1,0,0]},{el:"H",pos:[0,1,0]}], bonds:[[0,1],[0,2]]},
  {name:"Coupled Product", atoms:[{el:"C",pos:[0,0,0]},{el:"C",pos:[1,0,0]},{el:"O",pos:[2,0,0]},{el:"N",pos:[3,0,0]},{el:"H",pos:[0,1,0]}], bonds:[[0,1],[1,2],[2,3],[0,4]], animatedBond:[0,1]}
];

let currentStep = 0;
let group = new THREE.Group();
scene.add(group);

let animProgress = 0; // progress of animated bond
let animatedBondMesh = null;

function createMolecule(step){
  group.clear();
  animProgress = 0;
  animatedBondMesh = null;
  const mol = moleculeSteps[step];

  // Atoms
  mol.atoms.forEach(atom=>{
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(0.4,32,32),
      new THREE.MeshPhongMaterial({color:atomColors[atom.el]||0x888888})
    );
    sphere.position.set(...atom.pos);
    group.add(sphere);
  });

  // Bonds
  mol.bonds.forEach(b=>{
    const [i,j] = b;
    // Check if this is the animated bond
    if(mol.animatedBond && i===mol.animatedBond[0] && j===mol.animatedBond[1]){
      const start = new THREE.Vector3(...mol.atoms[i].pos);
      const end = new THREE.Vector3(...mol.atoms[j].pos);
      const mid = new THREE.Vector3().addVectors(start,end).multiplyScalar(0.5);
      animatedBondMesh = new THREE.Mesh(
        new THREE.CylinderGeometry(0.1,0.1,0.001,16),
        new THREE.MeshPhongMaterial({color:0xaaaaaa})
      );
      animatedBondMesh.position.copy(mid);
      const axis = new THREE.Vector3(0,1,0);
      const dir = new THREE.Vector3().subVectors(end,start);
      animatedBondMesh.quaternion.setFromUnitVectors(axis, dir.clone().normalize());
      animatedBondMesh.userData = {start,end};
      group.add(animatedBondMesh);
    } else {
      const start = new THREE.Vector3(...mol.atoms[i].pos);
      const end = new THREE.Vector3(...mol.atoms[j].pos);
      const length = start.distanceTo(end);
      const mid = new THREE.Vector3().addVectors(start,end).multiplyScalar(0.5);
      const cyl = new THREE.Mesh(
        new THREE.CylinderGeometry(0.1,0.1,length,16),
        new THREE.MeshPhongMaterial({color:0xaaaaaa})
      );
      cyl.position.copy(mid);
      const axis = new THREE.Vector3(0,1,0);
      cyl.quaternion.setFromUnitVectors(axis, new THREE.Vector3().subVectors(end,start).normalize());
      group.add(cyl);
    }
  });
}

// Initial display
createMolecule(currentStep);

// UI buttons
document.getElementById("next").onclick = ()=>{
  if(currentStep<moleculeSteps.length-1){
    currentStep++;
    createMolecule(currentStep);
  }
};

document.getElementById("prev").onclick = ()=>{
  if(currentStep>0){
    currentStep--;
    createMolecule(currentStep);
  }
};

// Animate
function animate(){
  requestAnimationFrame(animate);
  controls.update();

  // Animate the Câ€“C bond forming
  if(animatedBondMesh){
    animProgress += 0.02;
    if(animProgress>1) animProgress=1;
    const s = animatedBondMesh.userData.start;
    const e = animatedBondMesh.userData.end;
    const mid = new THREE.Vector3().lerpVectors(s,e,0.5);
    const length = s.distanceTo(e) * animProgress;
    animatedBondMesh.scale.set(1,animProgress,1);
    animatedBondMesh.position.copy(new THREE.Vector3().lerpVectors(s,e,animProgress/2));
  }

  renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>


